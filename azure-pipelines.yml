trigger:
  - main

pool:
  vmImage: ubuntu-latest  # Set the image to be used for the build

variables:
  tag: $(Build.BuildId)  # Tag with build ID

stages:
  - stage: BuildPushImage
    displayName: Build&Push Docker Image
    jobs:
      - job: Build_Image
        displayName: Build&Push Docker Image
        steps:
        - task: AzureCLI@2
          inputs:
            azureSubscription: 'ado_sc'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              # Build and push the Docker image
              docker build -t demoacr839.azurecr.io/app:$(Build.BuildId) .
              az acr login -n demoacr839
              docker push demoacr839.azurecr.io/app:$(Build.BuildId)
              sed -i 's#$(Build.BuildId)#'$(Build.BuildId)'#g' k8s/deployment.yaml

  - stage: DeployToAKS
    displayName: Deploying To AKS
    jobs:
      - job: DeployToAKS
        displayName: Deploying To AKS
        steps:
        - task: Kubernetes@1
          inputs:
            connectionType: 'Azure Resource Manager'
            azureSubscriptionEndpoint: 'ado_sc'
            azureResourceGroup: 'demo-aks-rg'
            kubernetesCluster: 'demo-aks'
            namespace: 'default'
            command: 'apply'
            useConfigurationFile: true
            configuration: 'k8s'
            containerRegistryType: 'Azure Container Registry'