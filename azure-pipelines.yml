trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  tag: $(Build.BuildId)
  acrName: demoacr839
  aksResourceGroup: demo-aks-rg
  aksCluster: demo-aks
  namespace: default

stages:
  - stage: BuildPushImage
    displayName: Build & Push Docker Image
    jobs:
      - job: Build_Image
        displayName: Build & Push Docker Image
        steps:
        - task: AzureCLI@2
          inputs:
            azureSubscription: 'ado_sc'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              docker build -t $(acrName).azurecr.io/app:$(tag) .
              az acr login -n $(acrName)
              docker push $(acrName).azurecr.io/app:$(tag)

  - stage: DeployToAKS
    displayName: Deploy to AKS
    jobs:
      - job: DeployToAKS
        displayName: Deploying to AKS
        steps:
        - task: AzureCLI@2
          inputs:
            azureSubscription: 'ado_sc'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              # Replace the placeholder acrName and tag in the YAML file using sed
              sed 's/\${acrName}/$(acrName)/g' k8s/vote_deploy.yaml > k8s/vote_deploy_substituted.yaml
              sed 's/\${tag}/$(tag)/g' k8s/vote_deploy_substituted.yaml > k8s/vote_deploy_new_build.yaml

              # Apply the substituted YAML file to the AKS cluster with validation turned off
              kubectl apply -f k8s/vote_deploy_new_build.yaml --validate=false
            displayName: 'Replace placeholders and deploy to AKS'